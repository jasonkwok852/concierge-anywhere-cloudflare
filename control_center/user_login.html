<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <style>
        :root {
            --main-color: #23396C;
            --secondary-color: #3A5A9A;
            --accent-color: #F8EF32;
            --bg-color: #FAFAFA;
            --border-color: #243D51;
            --header-bg: #243D51;
            --button-hover-color: #243D51;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        body {
            font-family: 'Noto Sans HK', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .login-container {
            width: 90%;
            max-width: 400px;
            margin: 20px auto;
            padding: 2rem;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .login-input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
        }
        .login-button {
            width: 100%;
            padding: 12px;
            margin: 16px 0;
            background-color: var(--main-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .login-button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        .error-message {
            color: #d32f2f;
            text-align: center;
            margin: 10px 0;
            display: none;
        }
        #labButton {
            background-color: var(--accent-color);
            color: var(--header-bg);
            border: 2px solid var(--header-bg);
            margin-bottom: 20px;
            width: 220px;
            padding: 10px 20px;
            font-size: 1rem;
            display: none;
        }
        #labButton:hover {
            background-color: var(--header-bg);
            color: var(--accent-color);
        }
        #welcomeMessage, #labAccess {
            display: none;
            text-align: center;
        }
        #loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        #debugPanel {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f5f5f5;
        }
    </style>
</head>
<body>
    <div id="loading">
        正在載入 Firebase 設定...
        <div id="debugPanel" style="margin-top: 20px; display: none;">
            <button onclick="testConfig()">測試配置請求</button>
            <pre id="configResult" style="background: #f5f5f5; padding: 10px;"></pre>
        </div>
    </div>

    <!-- 保持原有的 HTML 結構不變 -->

    <!-- 使用兼容版 Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script>
        // 全局變量
        let auth;
        const loadingDiv = document.getElementById('loading');
        const debugPanel = document.getElementById('debugPanel');
        const configResult = document.getElementById('configResult');

        // 測試配置端點
        window.testConfig = async function() {
            try {
                const response = await fetch('https://concierge-anywhere.com/firebase-config');
                const text = await response.text();
                configResult.innerHTML = `
                    Status: ${response.status}\n
                    Headers: ${JSON.stringify([...response.headers.entries()])}\n
                    Response: ${text}
                `;
            } catch (e) {
                configResult.innerHTML = `ERROR: ${e}`;
            }
        };

        // 初始化 Firebase
        async function initFirebase() {
            try {
                debugPanel.style.display = 'block';
                configResult.textContent = "正在請求配置...";
                
                // 從您的雲函數端點獲取配置
                const response = await fetch('https://concierge-anywhere.com/firebase-config', {
                    cache: 'no-store' // 確保獲取最新配置
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status} - 配置請求失敗`);
                }

                const firebaseConfig = await response.json();
                configResult.textContent = "獲取配置成功:\n" + JSON.stringify(firebaseConfig, null, 2);

                // 驗證必要字段
                const requiredKeys = ['apiKey', 'authDomain', 'projectId'];
                if (!requiredKeys.every(key => firebaseConfig[key])) {
                    throw new Error('Firebase 配置缺少必要字段');
                }

                // 初始化 Firebase
                const app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                
                loadingDiv.style.display = 'none';
                return auth;

            } catch (error) {
                console.error('Firebase初始化失敗:', error);
                loadingDiv.innerHTML = `
                    <p style="color: red;">Firebase 初始化失敗</p>
                    <p>${error.message}</p>
                    <button onclick="location.reload()">重新載入</button>
                    <div id="debugPanel" style="margin-top: 20px;">
                        <pre>${error.stack || '無錯誤堆棧'}</pre>
                    </div>
                `;
                throw error;
            }
        }

        // 保持原有的 showError、handleLogin、handleLogout、handleLabAccess 函數不變
        // ...

        // 初始化監聽
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                auth = await initFirebase();
                
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        console.log('用戶已登入:', user.email);
                        document.getElementById('loginForm').style.display = 'none';
                        document.getElementById('welcomeMessage').style.display = 'block';
                        document.getElementById('labButton').style.display = 'flex';
                        document.getElementById('userEmail').textContent = user.email;
                    } else {
                        console.log('用戶未登入');
                        document.getElementById('loginForm').style.display = 'block';
                        document.getElementById('welcomeMessage').style.display = 'none';
                        document.getElementById('labButton').style.display = 'none';
                    }
                });

                // 事件綁定
                document.getElementById('loginButton').addEventListener('click', handleLogin);
                document.getElementById('logoutButton').addEventListener('click', handleLogout);
                document.getElementById('labButton').addEventListener('click', handleLabAccess);
                document.getElementById('passwordInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleLogin();
                });

            } catch (error) {
                console.error('頁面初始化錯誤:', error);
            }
        });

        // 登入處理函數
        async function handleLogin() {
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value.trim();
            const loginButton = document.getElementById('loginButton');
            const errorMessageDiv = document.getElementById('errorMessage');
            
            if (!email || !password) {
                showError('請輸入電子郵件和密碼');
                return;
            }

            loginButton.disabled = true;
            loginButton.innerHTML = '<i class="bi bi-hourglass"></i> 登錄中...';
            errorMessageDiv.style.display = 'none';

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                console.error('登錄錯誤:', error);
                const errorMap = {
                    'auth/invalid-email': '電子郵件格式不正確',
                    'auth/user-not-found': '找不到此帳號',
                    'auth/wrong-password': '密碼錯誤',
                    'auth/invalid-credential': '電子郵件或密碼不正確',
                    'auth/too-many-requests': '嘗試次數過多，請稍後再試'
                };
                showError(errorMap[error.code] || '登錄失敗，請檢查電子郵件和密碼');
            } finally {
                loginButton.disabled = false;
                loginButton.innerHTML = '<i class="bi bi-box-arrow-in-right"></i> 登錄';
            }
        }

        // 實驗室訪問處理函數
        async function handleLabAccess() {
            const user = auth.currentUser;
            if (!user) {
                showError('請先登入', 'labError');
                return;
            }

            const labButton = document.getElementById('labButton');
            const labErrorDiv = document.getElementById('labError');
            
            labButton.disabled = true;
            labButton.innerHTML = '<i class="bi bi-hourglass"></i> 驗證中...';
            labErrorDiv.style.display = 'none';

            try {
                const idToken = await user.getIdToken();
                const workerResponse = await fetch('https://firebase-jwt-verify-worker.smit66476835.workers.dev', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!workerResponse.ok) {
                    const error = await workerResponse.text();
                    throw new Error(error || 'Worker 驗證失敗');
                }

                const { redirectUrl } = await workerResponse.json();
                window.location.href = redirectUrl || 'https://concierge-anywhere.com/private_room/my_laboratory';
            } catch (error) {
                console.error('實驗室訪問錯誤:', error);
                showError(`無法進入實驗室: ${error.message}`, 'labError');
            } finally {
                labButton.disabled = false;
                labButton.innerHTML = '<i class="bi bi-arrow-right-circle"></i> 進入我的實驗室';
            }
        }

        // 顯示錯誤訊息
        function showError(message, elementId = 'errorMessage') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
                element.textContent = '';
            }, 5000);
        }
    </script>
</body>
</html>