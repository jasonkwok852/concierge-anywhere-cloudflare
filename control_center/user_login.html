<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Concierge Anywhere 用戶登錄" />
    <meta name="keywords" content="用戶登錄, Concierge Anywhere, 顧客服務, 身份驗證" />
    <meta name="robots" content="index, follow" />
    <title>用戶登錄 - Concierge Anywhere</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+HK:wght@400;500;700&family=Archivo+Black&display=swap" rel="stylesheet" />
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            signInWithPopup, 
            GoogleAuthProvider, 
            signOut, 
            onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';

        // 從Cloudflare Function獲取配置
        async function getFirebaseConfig() {
            try {
                const response = await fetch('/firebase-config');
                if (!response.ok) throw new Error('Failed to fetch config');
                return await response.json();
            } catch (error) {
                console.error('配置獲取失敗:', error);
                throw error;
            }
        }

        // 初始化Firebase
        async function initializeFirebase() {
            try {
                const firebaseConfig = await getFirebaseConfig();
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                
                // 暴露auth對象
                window.firebaseAuth = auth;
                return auth;
            } catch (error) {
                console.error('Firebase初始化失敗:', error);
                throw error;
            }
        }

        // 立即初始化
        initializeFirebase().catch(error => {
            console.error("初始化錯誤:", error);
            document.getElementById('modalErrorMessage').textContent = '系統初始化失敗，請刷新頁面';
            document.getElementById('errorModal').style.display = 'flex';
        });
    </script>
    
    <!-- 原有CSS樣式保持不變 -->
    <style>
        /* 保持原有所有CSS樣式 */
        :root {
            --main-color: #23396C;
            /* ...其他變量定義 */
        }
        /* ...其他樣式規則 */
    </style>
</head>
<body>
    <!-- 保持原有HTML結構不變 -->
    <header>
        <!-- 原有header內容 -->
    </header>

    <main class="main-content">
        <h1 class="title">用戶登錄</h1>
        <div class="login-container" id="loginContainer">
            <div id="welcomeMessage" style="display: none; text-align: center;">
                <p>歡迎，<span id="userEmail"></span></p>
                <button class="logout-button" id="logoutButton">
                    <i class="bi bi-box-arrow-right"></i> 登出
                </button>
            </div>
            <div id="loginForm">
                <input type="email" id="emailInput" class="login-input" placeholder="電子郵件" aria-label="輸入電子郵件" />
                <input type="password" id="passwordInput" class="login-input" placeholder="密碼" aria-label="輸入密碼" />
                <button class="login-button" id="loginButton">
                    <i class="bi bi-box-arrow-in-right"></i> 登錄
                </button>
                <button class="google-login-button" id="googleLoginButton">
                    <i class="bi bi-google"></i> 使用 Google 登錄
                </button>
                <p class="error-message" id="errorMessage"></p>
            </div>
        </div>
        <div class="modal" id="errorModal">
            <div class="modal-content">
                <h3>錯誤</h3>
                <p id="modalErrorMessage">發生錯誤，請稍後再試。</p>
                <button class="modal-close" id="modalClose">關閉</button>
            </div>
        </div>
    </main>

    <footer>
        <!-- 原有footer內容 -->
    </footer>

    <script>
    (function() {
        'use strict';

        // DOM 元素緩存
        const elements = {
            // 保持原有元素緩存不變
            menuButton: document.getElementById('menuButton'),
            // ...其他元素引用
        };

        // 顯示錯誤消息
        function showError(message) {
            elements.errorMessage.textContent = message;
            elements.errorMessage.style.display = 'block';
            setTimeout(() => {
                elements.errorMessage.style.display = 'none';
            }, 5000);
        }

        // 顯示模態錯誤
        function showErrorModal(message) {
            elements.modalErrorMessage.textContent = message;
            elements.errorModal.style.display = 'flex';
        }

        // 關閉模態窗口
        function closeErrorModal() {
            elements.errorModal.style.display = 'none';
        }

        // 更新 UI 根據登錄狀態
        function updateUI(user) {
            if (user) {
                elements.loginForm.style.display = 'none';
                elements.welcomeMessage.style.display = 'block';
                elements.userEmail.textContent = user.email || '用戶';
                
                // 獲取ID令牌用於後端驗證
                user.getIdToken().then(token => {
                    console.log("ID Token:", token);
                    // 可以存儲在cookie或localStorage中供後端使用
                    localStorage.setItem('firebaseToken', token);
                });
            } else {
                elements.loginForm.style.display = 'block';
                elements.welcomeMessage.style.display = 'none';
                elements.emailInput.value = '';
                elements.passwordInput.value = '';
                localStorage.removeItem('firebaseToken');
            }
        }

        // 驗證電子郵件格式
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // 電子郵件/密碼登錄
        async function handleEmailLogin() {
            const email = elements.emailInput.value.trim();
            const password = elements.passwordInput.value.trim();

            if (!email || !password) {
                showError('請輸入電子郵件和密碼');
                return;
            }

            if (!isValidEmail(email)) {
                showError('請輸入有效的電子郵件地址');
                return;
            }

            try {
                elements.loginButton.disabled = true;
                elements.loginButton.innerHTML = '<i class="bi bi-hourglass-split"></i> 登錄中...';
                
                const auth = window.firebaseAuth;
                await signInWithEmailAndPassword(auth, email, password);
                
                elements.loginButton.disabled = false;
                elements.loginButton.innerHTML = '<i class="bi bi-box-arrow-in-right"></i> 登錄';
            } catch (error) {
                elements.loginButton.disabled = false;
                elements.loginButton.innerHTML = '<i class="bi bi-box-arrow-in-right"></i> 登錄';
                
                let message = '登錄失敗，請稍後再試';
                switch (error.code) {
                    case 'auth/invalid-email': message = '無效的電子郵件格式'; break;
                    case 'auth/user-not-found': message = '用戶不存在'; break;
                    case 'auth/wrong-password': message = '密碼錯誤'; break;
                    case 'auth/too-many-requests': message = '請求過多，請稍後再試'; break;
                }
                showError(message);
            }
        }

        // Google 登錄
        async function handleGoogleLogin() {
            try {
                const auth = window.firebaseAuth;
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                showErrorModal('Google 登錄失敗：' + error.message);
            }
        }

        // 登出
        async function handleLogout() {
            try {
                const auth = window.firebaseAuth;
                await signOut(auth);
                updateUI(null);
            } catch (error) {
                showErrorModal('登出失敗：' + error.message);
            }
        }

        // 監聽認證狀態
        function initAuthListener() {
            try {
                const auth = window.firebaseAuth;
                if (!auth) {
                    throw new Error("Firebase Auth未初始化");
                }
                
                onAuthStateChanged(auth, user => {
                    updateUI(user);
                });
            } catch (error) {
                console.error("Auth listener error:", error);
                showErrorModal('身份驗證初始化失敗: ' + error.message);
            }
        }

        // 初始化事件監聽器
        function initEvents() {
            // 保持原有事件監聽器不變
            elements.menuButton.addEventListener('click', (e) => {
                e.stopPropagation();
                elements.dropdownMenu.classList.toggle('show');
            });

            // ...其他事件監聽器

            elements.loginButton.addEventListener('click', handleEmailLogin);
            elements.googleLoginButton.addEventListener('click', handleGoogleLogin);
            elements.logoutButton.addEventListener('click', handleLogout);
            elements.modalClose.addEventListener('click', closeErrorModal);
            
            elements.emailInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleEmailLogin();
            });
            elements.passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleEmailLogin();
            });
        }

        // 初始化
        function init() {
            initEvents();
            // 延遲初始化監聽器確保Firebase已加載
            setTimeout(initAuthListener, 500);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    })();
    </script>
</body>
</html>