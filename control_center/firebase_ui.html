<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Authentication</title>
    <!--
      Tailwind CSS CDN for quick and modern styling.
      This helps create a responsive and visually appealing layout.
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!--
      Google Fonts - Inter for a clean and modern font.
      This ensures good readability across devices.
    -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!--
      Firebase UI CSS for authentication widget styling.
      Version 6.0.1 is compatible with Firebase SDK v9.x.
    -->
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css" />
    <style>
        /* Apply 'Inter' font to the entire body for a consistent look */
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <!--
      Main container for the login form, centered on the screen.
      Uses Tailwind classes for background, padding, rounded corners, shadow,
      width constraints, and responsive design.
    -->
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <!-- Page title -->
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">登入</h1>

        <!-- Loading indicator, shown while fetching Firebase config -->
        <div id="loading" class="text-center text-gray-600 mb-4">正在載入 Firebase 設定...</div>

        <!--
          Firebase UI authentication container.
          This div is where the Firebase UI widget will render the login forms.
          Initially hidden and shown once config is loaded.
        -->
        <div id="firebaseui-auth-container" class="hidden"></div>

        <!--
          Sign-out button, hidden by default and shown when a user is logged in.
          Styled with Tailwind for a clear call to action.
        -->
        <button id="sign-out" class="hidden mt-6 w-full py-3 bg-red-600 text-white font-semibold rounded-md shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 transition duration-300">登出</button>

        <!--
          User information display area, hidden by default and shown when a user is logged in.
          Displays user's name/email, UID, and profile picture if available.
        -->
        <div id="user-info" class="hidden mt-6 text-center text-gray-700"></div>
    </div>

    <script type="module">
        // Import necessary Firebase SDK modules using ES Modules syntax.
        // We are using Firebase v9.22.1 which is compatible with Firebase UI 6.0.1.
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
        // Import authentication providers like Email/Password and Google.
        import { EmailAuthProvider, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';

        // Get references to DOM elements for easy manipulation.
        const loadingDiv = document.getElementById('loading');
        const authContainer = document.getElementById('firebaseui-auth-container');
        const signOutButton = document.getElementById('sign-out');
        const userInfoDiv = document.getElementById('user-info');

        let ui; // Declare FirebaseUI instance globally to manage its state.

        /**
         * Fetches Firebase configuration dynamically from the Cloudflare Worker.
         * This enhances security by not hardcoding API keys in the frontend.
         * @returns {Promise<Object|null>} A promise that resolves to the Firebase config object, or null if an error occurs.
         */
        async function fetchFirebaseConfig() {
            try {
                // Modified fetch path to match Cloudflare Pages Functions routing behavior.
                // The function at `functions/firebase-config.js` is exposed at `/firebase-config`.
                const response = await fetch('/firebase-config');
                if (!response.ok) {
                    // Throw an error if the HTTP response status is not OK (e.g., 404, 500).
                    throw new Error(`HTTP 錯誤！狀態：${response.status}`);
                }
                // Parse the JSON response containing the Firebase configuration.
                return await response.json();
            } catch (error) {
                console.error("獲取 Firebase 設定時發生錯誤：", error);
                // Display an error message to the user if config loading fails.
                loadingDiv.textContent = '載入 Firebase 設定時發生錯誤。請檢查瀏覽器控制台以獲取詳細資訊。';
                return null;
            }
        }

        /**
         * Initializes Firebase and FirebaseUI, and sets up real-time authentication listeners.
         * This function orchestrates the entire authentication process.
         */
        async function initializeFirebaseApp() {
            // Fetch Firebase configuration from the Cloudflare Worker.
            const firebaseConfig = await fetchFirebaseConfig();

            // If configuration fetching failed, stop execution.
            if (!firebaseConfig) {
                return;
            }

            // Initialize Firebase app with the fetched configuration.
            const app = initializeApp(firebaseConfig);
            // Get the Auth service instance.
            const auth = getAuth(app);

            // Configure FirebaseUI for authentication.
            const uiConfig = {
                // The URL to redirect to after successful sign-in.
                // We redirect to the current page to refresh the state.
                signInSuccessUrl: window.location.href,
                // List of authentication providers to enable.
                // FirebaseUI will automatically render buttons for these.
                signInOptions: [
                    EmailAuthProvider.PROVIDER_ID, // Email/Password authentication
                    GoogleAuthProvider.PROVIDER_ID, // Google Sign-In
                    // Add other providers as needed, e.g., TwitterAuthProvider.PROVIDER_ID,
                ],
                // Optional: Terms of Service and Privacy Policy URLs.
                // Replace with your actual URLs.
                tosUrl: 'https://example.com/terms-of-service',
                privacyPolicyUrl: 'https://example.com/privacy-policy',
                callbacks: {
                    /**
                     * Callback invoked upon successful sign-in.
                     * @param {firebase.auth.UserCredential} authResult The result of the authentication operation.
                     * @param {string} redirectUrl The URL to redirect to.
                     * @returns {boolean} True to redirect, false to prevent default redirect.
                     */
                    signInSuccessWithAuthResult: function(authResult, redirectUrl) {
                        // User successfully signed in.
                        // You can perform additional actions here if needed.
                        return true; // Return true to continue with the redirect to signInSuccessUrl.
                    },
                    /**
                     * Callback invoked when the FirebaseUI widget is displayed.
                     * Used to hide the loading indicator and show the auth container.
                     */
                    uiShown: function() {
                        loadingDiv.style.display = 'none'; // Hide loading text
                        authContainer.classList.remove('hidden'); // Show auth container
                    }
                }
            };

            // Initialize the FirebaseUI Auth instance.
            // It requires the Firebase Auth service instance.
            // We load the firebaseui.auth.AuthUI class directly from the gstatic CDN.
            ui = new firebaseui.auth.AuthUI(auth);

            // Listen for changes in the authentication state (user logged in/out).
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in.
                    console.log('使用者已登入：', user.email || user.phoneNumber || user.uid);

                    // Hide the authentication UI and show the sign-out button and user info.
                    authContainer.classList.add('hidden');
                    signOutButton.classList.remove('hidden');
                    userInfoDiv.classList.remove('hidden');

                    // Display user information.
                    userInfoDiv.innerHTML = `
                        <p class="text-lg font-medium">歡迎，${user.displayName || user.email || '使用者'}！</p>
                        <p class="text-sm text-gray-500">使用者 ID: ${user.uid}</p>
                        ${user.photoURL ? `<img src="${user.photoURL}" alt="個人資料" class="w-16 h-16 rounded-full mx-auto mt-4 shadow-md">` : ''}
                    `;
                    loadingDiv.style.display = 'none'; // Ensure loading is hidden

                    // If FirebaseUI instance is active, reset it to clear its state
                    // and prevent it from showing the login form unnecessarily.
                    if (ui.isStarted()) {
                        ui.reset();
                    }

                } else {
                    // User is signed out.
                    console.log('使用者已登出。');

                    // Show the authentication UI and hide user info and sign-out button.
                    authContainer.classList.remove('hidden');
                    signOutButton.classList.add('hidden');
                    userInfoDiv.classList.add('hidden');
                    userInfoDiv.innerHTML = ''; // Clear user info

                    // Only start FirebaseUI if it's not already running.
                    // This prevents errors if ui.start() is called multiple times without need.
                    if (!ui.isStarted()) {
                        ui.start('#firebaseui-auth-container', uiConfig);
                    }
                    loadingDiv.style.display = 'none'; // Ensure loading is hidden
                }
            });

            // Add event listener for the sign-out button.
            signOutButton.addEventListener('click', async () => {
                try {
                    await signOut(auth); // Sign out the current user.
                    console.log('使用者已成功登出。');
                } catch (error) {
                    console.error('登出時發生錯誤：', error);
                    // You might want to show a message to the user here.
                }
            });

            // Start the FirebaseUI widget when the page loads initially
            // if no user is signed in. This is also handled by onAuthStateChanged.
            // We call it here to ensure it attempts to start right away if no session is found.
            if (!auth.currentUser) {
                loadingDiv.style.display = 'none'; // Hide loading text
                authContainer.classList.remove('hidden'); // Show auth container
                ui.start('#firebaseui-auth-container', uiConfig);
            }
        }

        // Ensure the Firebase app initialization happens only after the DOM is fully loaded.
        document.addEventListener('DOMContentLoaded', initializeFirebaseApp);
    </script>
</body>
