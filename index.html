<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <!-- 其他 head 內容保持不變 -->
    <style>
        /* 新增 Turnstile 容器樣式 */
        .turnstile-container {
            margin: 1.5rem 0;
            display: none;
            justify-content: center;
            width: 100%;
            min-height: 65px; /* 確保驗證元件有足夠空間 */
        }
        
        .cf-turnstile {
            margin: 0 auto; /* 居中顯示 */
        }
        
        /* 其他原有樣式保持不變 */
    </style>
</head>
<body>
    <!-- 其他 HTML 結構保持不變 -->

    <!-- 修改 Turnstile 容器部分 -->
    <div class="turnstile-container" id="turnstileContainer">
        <div class="cf-turnstile" 
             data-sitekey="0x4AAAAAAAQOrX6jyaqqHxdp"
             data-callback="onTurnstileSuccess"></div>
    </div>

    <script>
    (function() {
        'use strict';

        const state = {
            isVerified: false,
            pendingAction: null,
            isTurnstileRendered: false
        };

        // ... 其他變量保持不變 ...

        function showTurnstile() {
            elements.turnstileContainer.style.display = 'flex';
            
            if (state.isTurnstileRendered && window.turnstile) {
                console.log('Turnstile 已渲染，正在重置');
                window.turnstile.reset();
                return;
            }

            if (window.turnstile) {
                try {
                    console.log('Turnstile 自動初始化中...');
                    state.isTurnstileRendered = true;
                } catch (error) {
                    console.error('Turnstile 初始化錯誤:', error);
                    alert('驗證元件初始化失敗，請刷新頁面');
                    elements.turnstileContainer.style.display = 'none';
                    state.isTurnstileRendered = false;
                }
            } else {
                console.error('Turnstile 腳本未載入');
                alert('無法載入驗證元件，請刷新頁面後重試');
            }
        }

        window.onTurnstileSuccess = function(token) {
            console.log('Turnstile 驗證成功，Token:', token);
            
            if (!state.pendingAction) {
                console.warn('驗證成功，但無待處理動作');
                return;
            }
            
            state.isVerified = true;
            console.log('前端驗證已完成', state.pendingAction);
            
            // 顯示驗證成功提示
            alert('驗證成功！您可以繼續操作');
            
            // 注意：這裡不再自動跳轉
        };

        // 在需要跳轉的地方加入檢查（例如搜尋按鈕）
        function performSearch() {
            const keyword = elements.searchInput.value.trim();
            if (!keyword) {
                alert('請輸入關鍵字');
                return;
            }
            
            if (!state.isVerified) {
                alert('請先完成驗證');
                state.pendingAction = { type: 'search', value: keyword };
                debounceShowTurnstile();
                return;
            }
            
            console.log('執行搜尋，關鍵字:', keyword);
            redirectToRetool({ type: 'search', value: keyword });
        }

        // ... 其他函數保持不變 ...

    })();
    </script>
</body>
</html>
